<!-- <script>
	import { createEventDispatcher } from 'svelte';

	// Declar variables.
	export let field = {};
	const defaultAttributes = {
		id: '',
		spellcheck: false,
		autocorrect: 'off',
		autocomplete: 'off',
		placeholder: 'Tap here...'
	};
	const fieldAttributes = field.attributes ? field.attributes : {};
	field.attributes = { ...defaultAttributes, ...fieldAttributes };

	const defaultExtra = {
		loadItemes: [],
		multiple: false
	};
	const fieldExtra = field.extra ? field.extra : {};
	field.extra = { ...defaultExtra, ...fieldExtra };

	let items = field.extra.loadItemes;
	let itemsFiltered = [];

	let itemsSelectedFilterer = () => {
		if (field.value && Array.isArray(field.value) && field.value.length) {
			const defaultValues = field.value.filter((item) => {
				const oldSelected = items.filter((s) => s.value === item.value && s.title === item.title);
				if (oldSelected.length) {
					return oldSelected[0];
				}
			});
			return defaultValues;
		} else {
			return [];
		}
	};
	let itemsSelected = itemsSelectedFilterer();

	let hideListItems = true;
	let useFilter = false;
	let value = null;

	const dispatch = createEventDispatcher();

	// Select item.
	const onSelectItem = (item) => {
		hideListItems = true;
		const oldSelected = itemsSelected.filter((s) => s.value === item.value);
		if (oldSelected.length === 0) {
			itemsSelected = [...itemsSelected, item];
			items = items.filter((i) => i.value != item.value);
		}
		if (useFilter) {
			itemsFiltered = items;
		}

		// Affect values.
		dispatch('changeValue', {
			name: field.name,
			value: itemsSelected
		});

		value = '';

		// placeholder
		field.attributes.placeholder = field.extra.multiple ? field.attributes.placeholder : '';
	};

	// Delete tag
	const deleteTag = (item) => {
		itemsSelected = itemsSelected.filter((i) => i.value != item.value);
		items = [...items, item];
		if (useFilter) {
			itemsFiltered = items;
		}

		// Affect values.
		dispatch('changeValue', {
			name: field.name,
			value: itemsSelected
		});
	};

	// Clear all items selected.
	function clearAll() {
		itemsSelected = [];
		items = field.extra.loadItemes;
		if (useFilter) {
			itemsFiltered = items;
		}

		// Affect values.
		dispatch('changeValue', {
			name: field.name,
			value: itemsSelected
		});
	}

	// Filter item.
	const onFilter = (e) => {
		const keyword = e.target.value;
		if (keyword.length > 2) {
			hideListItems = false;
			const filtered = items.filter((entry) => {
				return Object.values(entry).some((val) => typeof val === 'string' && val.includes(keyword));
			});
			if (filtered.length > 0) {
				itemsFiltered = filtered;
				useFilter = true;
			} else {
				itemsFiltered = [];
				useFilter = false;
			}
			hideListItems = useFilter > 0 ? false : true;
		} else {
			hideListItems = true;
		}
	};
</script>

<div class="select-container">
	{#if itemsSelected.length > 0}
		{#each itemsSelected as itemSelected}
			<div class="item-selected {field.extra.multiple ? 'tag' : ''}">
				<span>{itemSelected.title}</span>
				{#if field.extra.multiple}
					<div class="clear" on:click={() => deleteTag(itemSelected)}>
						<svg width="100%" height="100%" viewBox="-2 -2 50 50" focusable="false">
							<path
								d="M34.923,37.251L24,26.328L13.077,37.251L9.436,33.61l10.923-10.923L9.436,11.765l3.641-3.641L24,19.047L34.923,8.124
                l3.641,3.641L27.641,22.688L38.564,33.61L34.923,37.251z"
							/>
						</svg>
					</div>
				{/if}
			</div>
		{/each}
		<div class="clear-all" on:click={clearAll}>
			<svg
				width="100%"
				height="100%"
				viewBox="-2 -2 50 50"
				focusable="false"
				role="presentation"
				class="svelte-e3bo9s"
			>
				<path
					fill="currentColor"
					d="M34.923,37.251L24,26.328L13.077,37.251L9.436,33.61l10.923-10.923L9.436,11.765l3.641-3.641L24,19.047L34.923,8.124
          l3.641,3.641L27.641,22.688L38.564,33.61L34.923,37.251z"
				/>
			</svg>
		</div>
	{/if}

	<input
		id={field.attributes.id}
		type="text"
		spellcheck={field.attributes.spellcheck}
		autocorrect={field.attributes.autocorrect}
		autocomplete={field.attributes.autocomplete}
		placeholder={field.attributes.placeholder}
		on:keyup={onFilter}
		bind:value
	/>

	{#if !hideListItems}
		<div style="position: relative; width: 100%;">
			<div class="items-container">
				{#if useFilter}
					{#each itemsFiltered as item}
						<div
							class="item"
							on:click={() => {
								onSelectItem(item);
							}}
						>
							<span>{item.title}</span>
						</div>
					{/each}
				{:else}
					{#each items as item}
						<div
							class="item"
							on:click={() => {
								onSelectItem(item);
							}}
						>
							<span>{item.title}</span>
						</div>/انمي-arcane-الحلقة-1-الاولي-مترجمة/watch/
					{/each}
				{/if}
			</div>
		</div>
	{/if}
</div>

<style>
	.select-container {
		border: solid 1px #dddddd;
		border-radius: 4px;
		height: auto;
		position: relative;
		display: flex;
		flex-wrap: wrap;
	}
	.select-container input {
		border: none;
		padding: 0 15px;
		height: 40px;
		width: 100%;
		box-sizing: border-box;
	}
	.items-container {
		box-shadow: 0 2px 3px 0 rgba(44, 62, 80, 0.24);
		background: #ffffff;
		border-radius: 0 0 5px 5px;
		overflow-y: auto;
		position: absolute;
		top: 0;
		z-index: 2;
		width: 100%;
	}
	.items-container .item,
	.item-selected {
		height: 40px;
		line-height: 40px;
		padding: 0 20px;
		overflow: hidden;
	}
	.items-container .item:first-child,
	.items-container .item:hover {
		background-color: #fbd5c8;
		cursor: pointer;
	}
	.item-selected,
	.clear-all {
		position: absolute;
		z-index: 2;
	}
	.item-selected {
		display: flex;
		flex-wrap: wrap;
	}
	.clear-all {
		right: 20px;
		width: 20px;
		height: 40px;
		cursor: pointer;
	}
	.clear {
		cursor: pointer;
	}
	.tag {
		background-color: #ddd;
		border-radius: 15px;
		height: 25px;
		line-height: 25px;
		margin: 8px 5px;
		padding: 0 30px 0 10px;
		position: relative;
		display: flex;
		flex-wrap: wrap;
	}
	.tag .clear {
		box-shadow: 0 2px 3px 0 rgba(44, 62, 80, 0.24);
		border-radius: 50%;
		width: 15px;
		height: 15px;
		padding: 2px;
		position: absolute;
		right: 5px;
		top: 3px;
		background-color: #ff3e00;
	}
	.tag .clear:hover {
		background-color: #fbd5c8;
	}
	.tag .clear svg {
		fill: white;
		vertical-align: top;
	}
	input:focus {
		outline: none;
	}
</style> -->
<script>import { createEventDispatcher } from 'svelte';
import { clickOutside } from '../../utils';
export let field;
// Dispatch.
const dispatch = createEventDispatcher();
let value = null;
let items = [];
let itemsFiltered = [];
let selectedItems = [];
$: values = selectedItems;
let showList = false;
let filter_length = 0;
if (field.extra) {
    if (field.extra.loadItemes) {
        items = field.extra.loadItemes;
    }
    if (field.extra.filter_length) {
        filter_length = field.extra.filter_length;
    }
}
const onFilter = (event) => {
    const keyword = event.currentTarget.value;
    if (keyword.length > filter_length) {
        const filtered = items.filter((item) => {
            return item.title.toLowerCase().includes(keyword.toLowerCase());
        });
        if (filtered.length) {
            itemsFiltered = filtered;
        }
        else {
            itemsFiltered = [];
        }
    }
    itemsFiltered.length ? (showList = true) : (showList = false);
};
const onSelectItem = (item) => (e) => {
    // showList = false;
    value = null;
    items = items.filter((_item) => _item.value !== item.value);
    itemsFiltered = itemsFiltered.filter((_item) => _item.value !== item.value);
    selectedItems = [...selectedItems, item];
    if (!items.length) {
        showList = false;
    }
    dispatch('changeValue', {
        name: field.name,
        value: selectedItems
    });
};
const onDeselectItem = (item) => async (e) => {
    // showList = false;
    selectedItems = await selectedItems.filter((_item) => _item.value !== item.value);
    items = [...items, item];
    itemsFiltered = [...itemsFiltered, item];
    dispatch('changeValue', {
        name: field.name,
        value: selectedItems
    });
};
const onClickOutside = (e) => {
    showList = false;
};
</script>

<div class="autocomplete-wrapper">
	<div class="selected-items">
		{#each selectedItems as item}
			<div class="item">
				<span>{item.title}</span>
				<span class="deselect" on:click={onDeselectItem(item)}>x</span>
			</div>
		{/each}
	</div>

	<input
		type="text"
		id={field.attributes.id}
		class={field.attributes.classes?.join(' ')}
		autocorrect={field.attributes.autocorrect}
		autocomplete={field.attributes.autocomplete}
		placeholder={field.attributes.placeholder}
		on:keyup={onFilter}
		bind:value
	/>

	{#if itemsFiltered.length && showList}
		<div class="list-items" use:clickOutside on:click_outside={onClickOutside}>
			<ul>
				{#each itemsFiltered as item}
					<li on:click={onSelectItem(item)}>{item.title}</li>
				{/each}
				<li
					class="done"
					on:click={() => {
						showList = false;
						value = null;
					}}
				>
					Done
				</li>
			</ul>
		</div>
	{/if}
</div>

<style>.autocomplete-wrapper {
  position: relative;
  width: 100%;
}
.autocomplete-wrapper .selected-items {
  margin-bottom: 10px;
  width: 100%;
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;
  align-content: flex-start;
  gap: 10px;
}
.autocomplete-wrapper .selected-items .item {
  font-size: 0.75rem;
  padding: 0.5rem;
  background-color: #ff3e00;
  color: white;
  border-radius: 5px;
}
.autocomplete-wrapper .selected-items .item .deselect {
  border-radius: 50%;
  width: 15px;
  height: 15px;
  padding: 2px 7px 3px 7px;
  font-size: 0.6rem;
  background-color: #333333;
  border: solid 1px rgba(255, 255, 255, 0.2);
  color: white;
}
.autocomplete-wrapper .selected-items .item .deselect:hover {
  box-shadow: 0px 0px 4px 1px rgba(255, 255, 255, 0.8);
}
.autocomplete-wrapper .selected-items .deselect {
  cursor: pointer;
}
.autocomplete-wrapper .list-items {
  box-shadow: 0 2px 3px 0 rgba(249, 251, 253, 0.24);
  margin-bottom: 20px;
}
.autocomplete-wrapper .list-items ul,
.autocomplete-wrapper .list-items li {
  list-style: none;
  padding: 0;
  margin: 0;
  color: black;
  background-color: rgb(201, 201, 201);
}
.autocomplete-wrapper .list-items li {
  border-bottom: 1px dashed #999999;
  padding: 0.75rem;
  cursor: pointer;
}
.autocomplete-wrapper .list-items li.done {
  background-color: #1f2d38 !important;
  border-bottom-color: transparent;
  color: white;
  text-align: center;
}
.autocomplete-wrapper .list-items li.done:hover {
  border-bottom-color: transparent;
}
.autocomplete-wrapper .list-items li:hover {
  background-color: rgba(255, 64, 0, 0.6117647059);
  border-bottom: 1px dashed #ff3e00;
  color: white;
}</style>
