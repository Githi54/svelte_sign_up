<script>import { createEventDispatcher } from 'svelte';
import { clickOutside } from '../../utils';
export let field;
// Dispatch.
const dispatch = createEventDispatcher();
let value = null;
let items = [];
let itemsFiltered = [];
let selectedItems = [];
let showList = false;
let filter_length = 0;
if (field.extra) {
    if (field.extra.loadItemes) {
        items = field.extra.loadItemes;
    }
    if (field.extra.filter_length) {
        filter_length = field.extra.filter_length;
    }
}
const onFilter = (event) => {
    const keyword = event.currentTarget.value;
    if (keyword.length > filter_length) {
        const filtered = items.filter((item) => {
            return item.title.toLowerCase().includes(keyword.toLowerCase());
        });
        if (filtered.length) {
            itemsFiltered = filtered;
        }
        else {
            itemsFiltered = [];
        }
        itemsFiltered.length ? (showList = true) : (showList = false);
    }
    else {
        showList = false;
    }
};
const onSelectItem = (item) => (e) => {
    // showList = false;
    value = null;
    items = items.filter((_item) => _item.value !== item.value);
    itemsFiltered = itemsFiltered.filter((_item) => _item.value !== item.value);
    selectedItems = [...selectedItems, item];
    if (!items.length) {
        showList = false;
    }
    dispatch('changeValue', {
        name: field.name,
        value: selectedItems
    });
};
const onDeselectItem = (item) => async (e) => {
    // showList = false;
    selectedItems = await selectedItems.filter((_item) => _item.value !== item.value);
    items = [...items, item];
    itemsFiltered = [...itemsFiltered, item];
    dispatch('changeValue', {
        name: field.name,
        value: selectedItems
    });
};
const onClickOutside = (e) => {
    showList = false;
};
</script>

<div class="autocomplete-wrapper">
	<div class="selected-items">
		{#each selectedItems as item}
			<div class="item">
				<span>{item.title}</span>
				<span class="deselect" on:click={onDeselectItem(item)}>x</span>
			</div>
		{/each}
	</div>

	<input
		type="text"
		id={field.attributes.id}
		class={field.attributes.classes?.join(' ')}
		autocorrect={field.attributes.autocorrect}
		autocomplete={field.attributes.autocomplete}
		placeholder={field.attributes.placeholder}
		on:keyup={onFilter}
		bind:value
	/>

	{#if itemsFiltered.length && showList}
		<div class="list-items" use:clickOutside on:click_outside={onClickOutside}>
			<ul>
				{#each itemsFiltered as item}
					<li on:click={onSelectItem(item)}>{item.title}</li>
				{/each}
				<li
					class="done"
					on:click={() => {
						showList = false;
						value = null;
					}}
				>
					Close
				</li>
			</ul>
		</div>
	{/if}
</div>

<style>.autocomplete-wrapper {
  position: relative;
  width: 100%;
}
.autocomplete-wrapper .selected-items {
  margin-bottom: 10px;
  width: 100%;
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start;
  align-content: flex-start;
  gap: 10px;
}
.autocomplete-wrapper .selected-items .item {
  font-size: 0.75rem;
  padding: 0.5rem;
  background-color: #ff3e00;
  color: white;
  border-radius: 5px;
}
.autocomplete-wrapper .selected-items .item .deselect {
  border-radius: 50%;
  width: 15px;
  height: 15px;
  padding: 2px 7px 3px 7px;
  font-size: 0.6rem;
  background-color: #333333;
  border: solid 1px rgba(255, 255, 255, 0.2);
  color: white;
}
.autocomplete-wrapper .selected-items .item .deselect:hover {
  box-shadow: 0px 0px 4px 1px rgba(255, 255, 255, 0.8);
}
.autocomplete-wrapper .selected-items .deselect {
  cursor: pointer;
}
.autocomplete-wrapper .list-items {
  box-shadow: 0 2px 3px 0 rgba(249, 251, 253, 0.24);
  margin-bottom: 20px;
}
.autocomplete-wrapper .list-items ul,
.autocomplete-wrapper .list-items li {
  list-style: none;
  padding: 0;
  margin: 0;
  color: black;
  background-color: rgb(201, 201, 201);
}
.autocomplete-wrapper .list-items li {
  border-bottom: 1px dashed #999999;
  padding: 0.75rem;
  cursor: pointer;
}
.autocomplete-wrapper .list-items li.done {
  background-color: #1f2d38 !important;
  border-bottom-color: transparent;
  color: white;
  text-align: center;
}
.autocomplete-wrapper .list-items li.done:hover {
  border-bottom-color: transparent;
}
.autocomplete-wrapper .list-items li:hover {
  background-color: rgba(255, 64, 0, 0.6117647059);
  border-bottom: 1px dashed #ff3e00;
  color: white;
}</style>
